#!/usr/bin/make -f
# -*- makefile -*-

CMAKE_OPTS := \
	-D CMAKE_INSTALL_PREFIX=$(CURDIR)/debian/tmp/usr

libdnds/CMakeCache.txt:
	dh_testdir
	# Add here commands to configure the package.
	cd libdnds; [ ! -e CMakeCache.txt ] || rm CMakeCache.txt
	cd libdnds; cmake $(CMAKE_OPTS) .

dnc/CMakeCache.txt:
	dh_testdir
	# Add here commands to configure the package.
	cd dnc; [ ! -e CMakeCache.txt ] || rm CMakeCache.txt
	cd dnc; cmake $(CMAKE_OPTS) .

build: build-stamp

build-stamp: udt4
	dh_testdir

	# Add here commands to compile the package.
#	$(MAKE) -C libdnds
#	$(MAKE) -C dnc
	cmake .
	$(MAKE) .

	touch $@

udt4:
	$(MAKE) -C udt4

binary:
	dh_testdir -a
	dh_testroot -a
#	$(MAKE) -C libdnds install
#	$(MAKE) -C dnc install
	$(MAKE) -C . install
	install -d $(CURDIR)/debian/tmp/etc/
	install -m 644 $(CURDIR)/debian/tmp/usr/share/dnds/dnc.conf $(CURDIR)/debian/tmp/etc
	dh_installdocs -a
	dh_install --sourcedir debian/tmp
	dh_lintian -a
	dh_strip -a
	dh_fixperms -a
	dh_makeshlibs -a
	dh_installdeb -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

clean: 
	dh_testdir
	dh_testroot
	rm -rf debian/tmp

.PHONY: clean build udt4

# %:
# 	dh $@ 

# override_dh_auto_build:
# 	dh_auto_build
# 	# Make apache module
# 	$(MAKE) libdir=$(CURDIR)/lib module

# override_dh_auto_install:
# 	$(MAKE) prefix=$(CURDIR)/debian/tmp/usr exec_prefix=$(CURDIR)/debian/tmp/usr install-lib install-util install-cgi
# 	# Install apache module
# 	install -d $(CURDIR)/debian/tmp/etc/apache2/mods-available
# 	install -m 644 debian/mapcache.load $(CURDIR)/debian/tmp/etc/apache2/mods-available
# 	install -d $(CURDIR)/debian/tmp/usr/lib/apache2/modules
# 	install -m 644 apache/.libs/mod_mapcache.so $(CURDIR)/debian/tmp/usr/lib/apache2/modules
# 	dh_install --sourcedir debian/tmp
